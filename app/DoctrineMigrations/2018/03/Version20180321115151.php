<?php

namespace Application\Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration;
use Doctrine\DBAL\Schema\Schema;
use Doctrine\DBAL\Connection;
use Symfony\Component\DependencyInjection\ContainerAwareInterface;
use Symfony\Component\DependencyInjection\ContainerInterface;

/**
 * Auto-generated Migration: Please modify to your needs!
 */
class Version20180321115151 extends AbstractMigration implements ContainerAwareInterface
{
    /**
     * @var ContainerInterface
     */
    private $container;

    public function setContainer(ContainerInterface $container = null)
    {
        $this->container = $container;
    }

    /**
     * @param Schema $schema
     */
    public function up(Schema $schema)
    {
        // this up() migration is auto-generated, please modify it to your needs

        $this->skipIf(
            $this->container->getParameter('project.family') !== 'metalloprokat',
            'Миграция только для металлороката.'
        );

        $this->addSql("
              INSERT INTO newsletter (id, title, created_at, updated_at, start_at, processed_at, template)
              VALUES (:newsletter_id, 
              'Скидка 50% на подключение до 31.03.2018 на Металлопрокат.рy(+2016)', 
              '2018-03-21 12:28:13',
              '2018-03-21 12:28:13',
              '2018-03-21 12:28:13', 
              NULL,
              '@MetalProject/emails/Metalloprokat/metalloprokat_21_03_2018_discount.html.twig')",
            array('newsletter_id' => 34),
            array('newsletter_id' => \PDO::PARAM_INT)
        );

        $companiesIds = $this->getCompaniesIds();

        do {
            $spliceCompaniesIds = array_splice($companiesIds, 0 , 100);
            $this->addSql('
                INSERT INTO `newsletter_recipient` (`newsletter_id`, `subscriber_id`)
                SELECT :newsletter_id, subscribers.ID FROM UserSend AS subscribers
                  JOIN User AS user ON user.User_ID = subscribers.user_id
                  JOIN Message75 AS company ON user.ConnectCompany = company.Message_ID
                WHERE subscribers.is_invalid = false
                AND subscribers.deleted = false
                AND user.Checked = true
                AND subscribers.bounced_at IS NULL
                AND company.Message_ID IN (:companiesIds)
                ',
                array(
                    'newsletter_id' => 34,
                    'companiesIds' => $spliceCompaniesIds
                ),
                array(
                    'companiesIds' => Connection::PARAM_INT_ARRAY
                )
            );
        } while($companiesIds);

    }

    /**
     * @param Schema $schema
     */
    public function down(Schema $schema)
    {
        // this down() migration is auto-generated, please modify it to your needs

    }

    private function getCompaniesIds()
    {
        return array(
            5717,
            15625,
            20828,
            21675,
            22775,
            27239,
            27269,
            29734,
            30187,
            30886,
            32323,
            34819,
            36117,
            36126,
            38188,
            38425,
            38498,
            2021157,
            2022961,
            2024820,
            2027685,
            2028184,
            2028192,
            2029300,
            2029763,
            2030274,
            2030785,
            2030986,
            2031218,
            2032141,
            2032401,
            2032941,
            2034034,
            2035361,
            2035911,
            2036813,
            2037119,
            2037181,
            2037225,
            2037385,
            2037415,
            2037764,
            2038069,
            2039055,
            2039369,
            2040196,
            2040224,
            2043186,
            2043350,
            2043532,
            2043723,
            2044085,
            2044995,
            2045351,
            2046843,
            2047041,
            2047291,
            2047504,
            2047632,
            2048405,
            2048721,
            2048996,
            2049369,
            2049522,
            2050117,
            2050151,
            2050269,
            2050407,
            2050814,
            2051150,
            2051795,
            2052489,
            2052815,
            2053006,
            2053138,
            2053154,
            2053479,
            2053548,
            2053945,
            2053950,
            2054020,
            2054047,
            2054132,
            2054263,
            2054290,
            2054348,
            2054524,
            2054576,
            2054591,
            2054662,
            2055130,
            2055274,
            2055342,
            2055399,
            2055479,
            2055707,
            2055741,
            2055785,
            2055906,
            2055939,
            2056029,
            2056084,
            2056167,
            2056484,
            2056599,
            2056698,
            2056726,
            2056946,
            7,
            490,
            1611,
            3389,
            4059,
            4350,
            4941,
            6269,
            6302,
            6430,
            6634,
            7273,
            7308,
            7513,
            7708,
            7744,
            7858,
            8491,
            8589,
            8630,
            8835,
            8868,
            8908,
            9108,
            9281,
            9697,
            9754,
            9866,
            10615,
            10794,
            11215,
            11587,
            11611,
            11644,
            11973,
            12111,
            12260,
            13461,
            14189,
            14345,
            15172,
            15501,
            15592,
            16222,
            17666,
            17777,
            18736,
            18793,
            19324,
            19476,
            20523,
            20692,
            20995,
            21079,
            21424,
            21884,
            21943,
            22340,
            22813,
            22863,
            23030,
            23362,
            23506,
            24278,
            24506,
            25533,
            26726,
            26856,
            26938,
            26986,
            27184,
            27455,
            27583,
            27919,
            28331,
            28391,
            28471,
            28557,
            28747,
            29102,
            29121,
            29394,
            29659,
            29715,
            29718,
            29942,
            30328,
            30338,
            30342,
            30456,
            30464,
            30615,
            31135,
            31319,
            31347,
            33171,
            33665,
            33684,
            33871,
            34212,
            35500,
            35658,
            35692,
            36610,
            36726,
            37082,
            37339,
            37391,
            38278,
            38713,
            39103,
            39241,
            39488,
            39597,
            39856,
            40278,
            41925,
            41960,
            42783,
            43555,
            44755,
            45100,
            45247,
            45648,
            46125,
            46423,
            46590,
            46629,
            46715,
            47305,
            47681,
            2008044,
            2015112,
            2018426,
            2020850,
            2020858,
            2021165,
            2021230,
            2021699,
            2021816,
            2021925,
            2022085,
            2022268,
            2022331,
            2022560,
            2022882,
            2023881,
            2024180,
            2024371,
            2024588,
            2025160,
            2025185,
            2025242,
            2025377,
            2025507,
            2025916,
            2026182,
            2026679,
            2026695,
            2026841,
            2027111,
            2027347,
            2027395,
            2027515,
            2027783,
            2027822,
            2027935,
            2028092,
            2028511,
            2028565,
            2028635,
            2029096,
            2029152,
            2029315,
            2029338,
            2029584,
            2029593,
            2029631,
            2029654,
            2029748,
            2029791,
            2030010,
            2030203,
            2030233,
            2030309,
            2030401,
            2030517,
            2030548,
            2030560,
            2030571,
            2030850,
            2030856,
            2030862,
            2030894,
            2030937,
            2031155,
            2031168,
            2031190,
            2031427,
            2031503,
            2031507,
            2031538,
            2031694,
            2031696,
            2031722,
            2031779,
            2031873,
            2031876,
            2032012,
            2032125,
            2032251,
            2032419,
            2032424,
            2032453,
            2032461,
            2032462,
            2032503,
            2032507,
            2032533,
            2032548,
            2032569,
            2032582,
            2032622,
            2032634,
            2032675,
            2032749,
            2032779,
            2032809,
            2032815,
            2032838,
            2032891,
            2032932,
            2033009,
            2033045,
            2033101,
            2033154,
            2033171,
            2033174,
            2033252,
            2033270,
            2033395,
            2033524,
            2033530,
            2033537,
            2033547,
            2033667,
            2033703,
            2033731,
            2033762,
            2033836,
            2033851,
            2033943,
            2033981,
            2033997,
            2034038,
            2034106,
            2034133,
            2034140,
            2034208,
            2034227,
            2034311,
            2034389,
            2034400,
            2034402,
            2034454,
            2034507,
            2034510,
            2034562,
            2034585,
            2034616,
            2034620,
            2034680,
            2034740,
            2034772,
            2034774,
            2034781,
            2034786,
            2034787,
            2034810,
            2034860,
            2034906,
            2035035,
            2035115,
            2035118,
            2035174,
            2035221,
            2035302,
            2035317,
            2035327,
            2035333,
            2035372,
            2035546,
            2035585,
            2035612,
            2035702,
            2035712,
            2035715,
            2035725,
            2035770,
            2036208,
            2036216,
            2036286,
            2036317,
            2036374,
            2036464,
            2036490,
            2036567,
            2036648,
            2036692,
            2036708,
            2036808,
            2036841,
            2036855,
            2036937,
            2036986,
            2037020,
            2037214,
            2037405,
            2037410,
            2037610,
            2037637,
            2037665,
            2037692,
            2037693,
            2037714,
            2037809,
            2037875,
            2037889,
            2037892,
            2037956,
            2038010,
            2038091,
            2038115,
            2038195,
            2038369,
            2038370,
            2038373,
            2038460,
            2038606,
            2038682,
            2038747,
            2038849,
            2038852,
            2038988,
            2039082,
            2039407,
            2039449,
            2039454,
            2039668,
            2039749,
            2039781,
            2039784,
            2039843,
            2040001,
            2040021,
            2040188,
            2040426,
            2040469,
            2040496,
            2040633,
            2040873,
            2041017,
            2041026,
            2041038,
            2041116,
            2041231,
            2041240,
            2041462,
            2041467,
            2041497,
            2041641,
            2041704,
            2041813,
            2041933,
            2041948,
            2042037,
            2042122,
            2042348,
            2042425,
            2042553,
            2042637,
            2043247,
            2043396,
            2043477,
            2043546,
            2043718,
            2043742,
            2043790,
            2043821,
            2043922,
            2043966,
            2044015,
            2044073,
            2044116,
            2044151,
            2044458,
            2044492,
            2044539,
            2044552,
            2044663,
            2044826,
            2044827,
            2045049,
            2045378,
            2045643,
            2046112,
            2046249,
            2046265,
            2046392,
            2046477,
            2046478,
            2047040,
            2047080,
            2047128,
            2047313,
            2047411,
            2047559,
            2047924,
            2047983,
            2048108,
            2048167,
            2048241,
            2048306,
            2048475,
            2048486,
            2048494,
            2048568,
            2048627,
            2048692,
            2048784,
            2049061,
            2049066,
            2049075,
            2049140,
            2049580,
            2049584,
            2049624,
            2049691,
            2050071,
            2050134,
            2050267,
            2050817,
            2051052,
            2051220,
            2051528,
            2051585,
            2051620,
            2051710,
            2052007,
            2052035,
            2052052,
            2052143,
            2052214,
            2052216,
            2052241,
            2052357,
            2052388,
            2052408,
            2052418,
            2052530,
            2052567,
            2052597,
            2052781,
            2052976,
            2053516,
            2053544,
            2053551,
            2053575,
            2053653,
            2053688
        );
    }
}
